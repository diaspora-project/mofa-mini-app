FROM continuumio/miniconda3:latest

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update

RUN git clone https://github.com/globus-labs/mof-generation-at-scale.git

WORKDIR /mof-generation-at-scale

RUN git checkout octopus

COPY environment-cuda11.yml envs/environment-cuda11.yml

RUN conda update -n base conda \
    && conda install -n base conda-libmamba-solver \
    && conda config --set solver libmamba \
    && conda env create --file envs/environment-cuda11.yml

SHELL ["conda", "run", "--no-capture-output", "-n", "mofa", "/bin/bash", "-c"]
RUN conda install -y redis mongodb

COPY run_mini_app.sh .

LABEL org.opencontainers.image.source=https://github.com/diaspora-project/mofa-mini-app

ENTRYPOINT ["conda", "run", "--no-capture-output", "-n", "mofa", "/bin/bash", "/mof-generation-at-scale/run_mini_app.sh"]
